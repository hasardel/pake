/*
 * pake
 * https://github.com/hasardel/pake
 *
 * Copyright (c) 2014 Emmanuel Pouthier
 * Licensed under the MIT license.
 * https://github.com/hasardel/pake/blob/master/LICENSE
 */
var pake;!function(a){var b=function(){function a(){this._idx=0,this._idxMax=0}return a.prototype.printUsage=function(){var a="";a+="Usage: pake [<options>] command\n",a+="\n",a+="where <options> is :\n",a+="  --templates-dir=DIR\n",a+="  --modules-dir=DIR\n",a+="  --build-dir=DIR\n",a+="  --help\n",a+="  -h\n",a+="\n",a+="and <command> is: \n",a+="  create MODULENAME [TEMPLATENAME]\n",a+="  deps add MODULENAME DEPENDENCYNAMEn\n",a+="  deps remove MODULENAME DEPENDENCYNAMEn\n",a+="  deps list [MODULENAMEn]\n",a+="  resolve [MODULENAMEn]\n",console.log(a),process.exit(0)},a.prototype.parse=function(a){for(this._argv=a,this._idxMax=a.length,this._result=new Object,this._idx=1,this._consumeArg();this._parseOptions(););return this._parseCommand()||this.printUsage(),this._result},a.prototype._nextArg=function(){return this._idx<this._idxMax?this._argv[this._idx]:null},a.prototype._consumeArg=function(){this._idx++},a.prototype._restoreArg=function(){this._idx--},a.prototype._parseVariable=function(a){var b=this._nextArg();return b?(this._result[a]=b,this._consumeArg(),!0):!1},a.prototype._parseArrayVariable=function(a){var b=[],c="";c=this._nextArg(),c&&(b.push(c),this._consumeArg());do c=this._nextArg(),c&&(b.push(c),this._consumeArg());while(c);return b.length<=0?!1:(this._result[a]=b,!0)},a.prototype._parseOptions=function(){var a=this._nextArg();return!a||"--"!==a.substr(0,2)&&"-"!==a.substr(0,1)?!1:("--templates-dir="===a.substr(0,16)?this._result.templatesDir=a.substr(16):"--modules-dir="===a.substr(0,14)?this._result.modulesDir=a.substr(14):"--build-dir="===a.substr(0,12)?this._result.buildDir=a.substr(12):this.printUsage(),this._consumeArg(),!0)},a.prototype._parseCommand=function(){return this._parseCreate()||this._parseDependencies()||this._parseResolve()},a.prototype._parseCreate=function(){var a=this._nextArg();if(a&&"create"===a){if(this._result.command="create",this._consumeArg(),this._parseVariable("moduleName"))return this._parseVariable("templateName"),!0;this._restoreArg()}return!1},a.prototype._parseDependencies=function(){var a=this._nextArg();if(a&&("dependencies"===a||"deps"===a)){if(this._result.command="dependencies",this._consumeArg(),this._parseDependenciesAdd()||this._parseDependenciesRemove()||this._parseDependenciesList())return!0;this._restoreArg()}return!1},a.prototype._parseDependenciesAdd=function(){var a=this._nextArg();if(a&&"add"===a){if(this._result.subcommand="add",this._consumeArg(),this._parseVariable("moduleName")){if(this._parseArrayVariable("dependencyNames"))return!0;this._restoreArg()}this._restoreArg()}return!1},a.prototype._parseDependenciesRemove=function(){var a=this._nextArg();if(a&&"remove"===a){if(this._result.subcommand="remove",this._consumeArg(),this._parseVariable("moduleName")){if(this._parseArrayVariable("dependencyNames"))return!0;this._restoreArg()}this._restoreArg()}return!1},a.prototype._parseDependenciesList=function(){var a=this._nextArg();return a&&"list"===a?(this._result.subcommand="list",this._consumeArg(),this._parseArrayVariable("moduleNames"),!0):!1},a.prototype._parseResolve=function(){var a=this._nextArg();return a&&"resolve"===a?(this._result.command="resolve",this._consumeArg(),this._parseArrayVariable("moduleNames"),!0):!1},a}();a.CommandLineParser=b}(pake||(pake={}));var pake;!function(a){var b=function(){function a(){this._nbrSpaces=2}return a.prototype.getNbrSpaces=function(){return this._nbrSpaces},a.prototype.setNbrSpaces=function(a){this._nbrSpaces=a},a.prototype.readFile=function(a){var b=null;try{b=JSON.parse(fs.readFileSync(a))}catch(c){return null}return b},a.prototype.writeFile=function(a,b){var c=JSON.stringify(b,null,this._nbrSpaces);fs.writeFileSync(a,c)},a}();a.JsonFile=b}(pake||(pake={}));var fs=require("fs"),fse=require("fs-extra"),path=require("path"),pake;!function(a){var b=function(){function b(){this._templatesDirectory="",this._modulesDirectory="",this._scriptsDirectory="",this._buildDirectory="",this._commandLineParser=new a.CommandLineParser,this._jsonFile=new a.JsonFile,this._templatesDirectory=process.cwd()+"/templates",this._modulesDirectory=process.cwd()+"/modules",this._buildDirectory=process.cwd()+"/build",this._templates=new Object,this._modules=new Object,this._resolveList=new Array}return b.prototype.run=function(){var a=this._commandLineParser.parse(process.argv);a.templatesDir&&(this._templatesDirectory=path.resolve(a.templatesDir)),a.modulesDir&&(this._modulesDirectory=path.resolve(a.modulesDir)),a.buildDir&&(this._buildDirectory=path.resolve(a.buildDir)),"create"===a.command?a.templateName?this._create(a.moduleName,a.templateName):this._create(a.moduleName):"dependencies"===a.command?"add"===a.subcommand?this._dependenciesAdd(a.moduleName,a.dependencyNames):"remove"===a.subcommand?this._dependenciesRemove(a.moduleName,a.dependencyNames):"list"===a.subcommand&&(a.moduleNames?this._dependenciesList(a.moduleNames):this._dependenciesList()):"resolve"===a.command&&(a.moduleNames?this._resolve(a.moduleNames):this._resolve()),console.log("-> success")},b.prototype._create=function(a,b){"undefined"==typeof b&&(b="default"),this._scanTemplatesDirectory()||process.exit(1);var c=this._searchTemplate(b);c||("default"===b?c=new Object:(console.log('-> error: template "'+b+'" is not found !'),process.exit(1))),this._scanModulesDirectory()||process.exit(1),this._searchModule(a)&&(console.log('-> error: module "'+a+'" is already created !'),process.exit(1)),fs.existsSync(path.join(this._modulesDirectory,a.replace(/\./g,path.sep)))&&(console.log("-> error: directory name is already used"),process.exit(1)),console.log("Create module ..."),fse.mkdirpSync(path.join(this._modulesDirectory,a.replace(/\./g,path.sep))),fs.existsSync(path.join(this._templatesDirectory,b.replace(/\./g,path.sep)))&&fse.copySync(path.join(this._templatesDirectory,b.replace(/\./g,path.sep)),path.join(this._modulesDirectory,a.replace(/\./g,path.sep))),console.log('Update "pake.json" ...'),c.name=a,this._jsonFile.writeFile(path.join(this._modulesDirectory,a.replace(/\./g,path.sep),"pake.json"),c)},b.prototype._dependenciesAdd=function(a,b){this._scanModulesDirectory()||process.exit(1);var c=this._searchModule(a);c||(console.log('-> error: module "'+a+'" is not found !'),process.exit(1));for(var d in b)b[d]!==a?this._searchModule(b[d])?c.dependencies&&c.dependencies.indexOf(b[d])>-1?console.log('-> warning: dependency "'+b[d]+'" is already added !'):(console.log('Add dependency "'+b[d]+'" ...'),c.dependencies||(c.dependencies=new Array),c.dependencies.push(b[d])):console.log('-> warning: dependency not found "'+b[d]+'" !'):console.log('-> warning: cyclic dependency "'+b[d]+'" !');console.log('Update "pake.json" ...'),this._jsonFile.writeFile(path.join(this._modulesDirectory,a.replace(/\./g,path.sep),"pake.json"),c)},b.prototype._dependenciesRemove=function(a,b){this._scanModulesDirectory()||process.exit(1);var c=this._searchModule(a);if(c||(console.log('-> error: module "'+a+'" is not found !'),process.exit(1)),c.dependencies){var d=0;for(var e in b)d=c.dependencies.indexOf(b[e]),d>-1?(console.log('Remove dependency "'+b[e]+'" ...'),c.dependencies.splice(d,1)):console.log('-> warning: dependency not found "'+b[e]+'" !')}else console.log('-> error: module "'+a+'" has not dependencies !'),process.exit(1);console.log('Update "pake.json" ...'),this._jsonFile.writeFile(path.join(this._modulesDirectory,a.replace(/\./g,path.sep),"pake.json"),c)},b.prototype._dependenciesList=function(a){"undefined"==typeof a&&(a=null),console.log("deps list "+a)},b.prototype._resolve=function(a){if("undefined"==typeof a&&(a=null),console.log("Create build directory ..."),fs.existsSync(this._buildDirectory)&&fse.removeSync(this._buildDirectory),fs.mkdirSync(this._buildDirectory),this._scanModulesDirectory()||process.exit(1),this._resolveList=new Array,a)for(var b in a){var c=a[b];this._resolveModule(c)}else for(var c in this._modules)this._resolveModule(c)},b.prototype._resolveModule=function(a){if(this._resolveList.indexOf(a)<0){var b=this._searchModule(a);if(b||(console.log('-> error: module "'+a+'" is not found !'),process.exit(1)),console.log('Copy module "'+a+'" ...'),fse.mkdirpSync(path.join(this._buildDirectory,a.replace(/\./g,path.sep))),fse.copySync(path.join(this._modulesDirectory,a.replace(/\./g,path.sep)),path.join(this._buildDirectory,a.replace(/\./g,path.sep))),this._resolveList.push(a),b.dependencies){console.log("Resolve dependencies ("+b.dependencies.length+" found) ...");for(var c in b.dependencies)this._resolveModule(b.dependencies[c])}}},b.prototype._searchTemplate=function(a){console.log('Search template "'+a+'" ...');for(var b in this._templates)if(b===a)return this._templates[b];return null},b.prototype._searchModule=function(a){console.log('Search module "'+a+'" ...');for(var b in this._modules)if(b===a)return this._modules[b];return null},b.prototype._scanModulesDirectory=function(){if(console.log('Scan modules directory ("'+this._modulesDirectory+'") ...'),this._modules=new Object,fs.existsSync(this._modulesDirectory)){if(!fs.lstatSync(this._modulesDirectory).isDirectory())return console.log("-> error: modules directory is not directory !"),!1;if(fs.existsSync(path.join(this._modulesDirectory,"pake.json")))return console.log("-> error: root modules directory could not contain pake.json !"),!1;this._scanDirectory(this._modules,this._modulesDirectory)}else console.log("-> info: create modules directory"),fs.mkdirSync(this._modulesDirectory);return!0},b.prototype._scanTemplatesDirectory=function(){if(console.log('Scan templates directory ("'+this._templatesDirectory+'") ...'),this._templates=new Object,fs.existsSync(this._templatesDirectory)){if(!fs.lstatSync(this._templatesDirectory).isDirectory())return console.log("-> error: templates directory is not directory !"),!1;if(fs.existsSync(path.join(this._templatesDirectory,"pake.json")))return console.log("-> error: root templates directory could not contain pake.json !"),!1;this._scanDirectory(this._templates,this._templatesDirectory)}return!0},b.prototype._scanDirectory=function(a,b,c){"undefined"==typeof c&&(c="");var d=path.join(b,"pake.json");if(fs.existsSync(d)){var e=this._jsonFile.readFile(d);e?a[c]=e:console.log('-> warning: could not read "pake.json" of "'+c+'" !')}var f,g=fs.readdirSync(b);for(var h in g)f=path.join(b,g[h]),fs.lstatSync(f).isDirectory()&&this._scanDirectory(a,f,""===c?path.basename(f):c+"."+path.basename(f))},b}();a.Pake=b}(pake||(pake={})),process.title="pake",(new pake.Pake).run();
